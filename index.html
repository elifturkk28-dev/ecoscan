<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoScan PRO: Karbon Sepeti</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        :root { --primary: #059669; --bg: #f0fdf4; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: #1f2937; padding-bottom: 80px; }
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; font-size: 20px; font-weight: bold; }
        #scanner-container { width: 100%; height: 250px; background: black; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .controls { padding: 20px; text-align: center; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; width: 80%; cursor: pointer; }
        .result-card { background: white; margin: 15px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .cart-section { margin: 15px; background: white; border-radius: 12px; padding: 15px; }
        .cart-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; }
        .total-box { background: #064e3b; color: white; padding: 15px; margin: 15px; border-radius: 12px; text-align: center; }
        .footer-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; }
        .nav-item { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="scan-page">
    <div class="header">ğŸ” EcoScan: ÃœrÃ¼n Tara</div>
    <div id="scanner-container"><video id="video"></video></div>
    <div class="controls">
        <button class="btn" id="startBtn">TaramayÄ± BaÅŸlat</button>
    </div>
    <div id="result" class="result-card hidden">
        <h3 id="pName">ÃœrÃ¼n AdÄ±</h3>
        <p id="pInfo">Analiz ediliyor...</p>
        <p><strong>Tahmini Karbon Ä°z: </strong> <span id="pCO2">0</span> kg CO2</p>
        <button class="btn" id="addToCartBtn" style="background: #0ea5e9;">Sepete Ekle</button>
    </div>
</div>

<div id="cart-page" class="hidden">
    <div class="header">ğŸ›’ Karbon Sepetim</div>
    <div class="total-box">
        Toplanan Karbon Ä°z: <br>
        <span id="grandTotal" style="font-size: 24px;">0.00</span> kg CO2
    </div>
    <div class="cart-section" id="cartItems">
        Sepetiniz boÅŸ.
    </div>
    <div style="text-align:center">
        <button class="btn" onclick="clearCart()" style="background:#ef4444; width: 50%;">Sepeti SÄ±fÄ±rla</button>
    </div>
</div>

<div class="footer-nav">
    <div class="nav-item" onclick="showPage('scan')">ğŸ“¸ Tara</div>
    <div class="nav-item" onclick="showPage('cart')">ğŸ›’ Sepet (<span id="cartCount">0</span>)</div>
</div>

<script>
    const codeReader = new ZXing.BrowserMultiFormatReader();
    let currentProduct = null;
    let cart = [];

    // Sayfa GeÃ§iÅŸleri
    function showPage(page) {
        document.getElementById('scan-page').classList.toggle('hidden', page !== 'scan');
        document.getElementById('cart-page').classList.toggle('hidden', page !== 'cart');
    }

    document.getElementById('startBtn').addEventListener('click', () => {
        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
            if (result) {
                fetchData(result.text);
                codeReader.reset();
            }
        });
    });

    function fetchData(barcode) {
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('pName').innerText = "AranÄ±yor...";
        
        fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)
            .then(r => r.json())
            .then(data => {
                let name = "Bilinmeyen ÃœrÃ¼n";
                let co2 = (Math.random() * 2 + 0.5).toFixed(2); // Yedek Motor: EÄŸer veri yoksa kategorisel tahmin (Ã–rnek amaÃ§lÄ± random)

                if (data.status === 1) {
                    name = data.product.product_name || "Ä°simsiz ÃœrÃ¼n";
                    // EÄŸer gerÃ§ek karbon verisi varsa onu al, yoksa tahmin et
                    if(data.product.nutriments && data.product.nutriments["carbon-footprint-from-known-ingredients_100g"]) {
                        co2 = (data.product.nutriments["carbon-footprint-from-known-ingredients_100g"] / 10).toFixed(2);
                    }
                }
                
                currentProduct = { name, co2: parseFloat(co2) };
                document.getElementById('pName').innerText = name;
                document.getElementById('pCO2').innerText = co2;
                document.getElementById('pInfo').innerText = "Bu Ã¼rÃ¼nÃ¼n karbon verisi analiz edildi.";
            });
    }

    document.getElementById('addToCartBtn').addEventListener('click', () => {
        if(currentProduct) {
            cart.push(currentProduct);
            updateCart();
            alert("Sepete Eklendi!");
            document.getElementById('result').classList.add('hidden');
        }
    });

    function updateCart() {
        const list = document.getElementById('cartItems');
        const count = document.getElementById('cartCount');
        const totalDisp = document.getElementById('grandTotal');
        
        list.innerHTML = "";
        let total = 0;
        
        cart.forEach(item => {
            total += item.co2;
            list.innerHTML += `<div class="cart-item"><span>${item.name}</span><b>${item.co2} kg</b></div>`;
        });
        
        count.innerText = cart.length;
        totalDisp.innerText = total.toFixed(2);
    }

    function clearCart() {
        cart = [];
        updateCart();
        document.getElementById('cartItems').innerHTML = "Sepetiniz boÅŸ.";
    }
</script>

</body>
</html>
